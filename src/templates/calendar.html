{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
    
    <div id="message"></div>
    
    <div id="calendarContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ API
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –∑–∞–≥—Ä—É–∂–µ–Ω
    if (typeof TaskAPI === 'undefined' || typeof MeetingAPI === 'undefined' || typeof TeamAPI === 'undefined') {
        console.error('API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        document.getElementById('calendarContainer').innerHTML = '<div class="message error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
        return;
    }
    
    loadCalendarData();
});

let tasks = [];
let meetings = [];
let userDirectory = {};

async function loadCalendarData() {
    try {
        const container = document.getElementById('calendarContainer');
        container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        const [tasksResponse, meetingsResponse, teamsResponse] = await Promise.all([
            TaskAPI.getMyTasks().catch(() => []),
            MeetingAPI.getMyMeetings().catch(() => []),
            TeamAPI.getMyTeams().catch(() => [])
        ]);
        tasks = tasksResponse;
        meetings = meetingsResponse;
        userDirectory = buildUserDirectory(teamsResponse);
        
        renderCalendar();
    } catch (error) {
        document.getElementById('calendarContainer').innerHTML = `<div class="message error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
    }
}

function renderCalendar() {
    const container = document.getElementById('calendarContainer');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                       '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    
    let html = `<h3>${monthNames[currentMonth]} ${currentYear}</h3>`;
    html += '<div class="calendar">';
    
    const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    dayNames.forEach(day => {
        html += `<div class="calendar-day-header" style="font-weight: bold; text-align: center; padding: 0.5rem;">${day}</div>`;
    });
    
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day"></div>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayEvents = getEventsForDate(date);
        const dateStr = date.toISOString().split('T')[0];
        
        html += `<div class="calendar-day" onclick="showDayTimeline('${dateStr}')" style="cursor: pointer;">`;
        html += `<div class="calendar-day-header">${day}</div>`;
        
        dayEvents.forEach(event => {
            html += `<div class="calendar-event" style="background: ${event.color};">${event.title}</div>`;
        });
        
        html += `</div>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function getEventsForDate(date) {
    const events = [];
    const dateStr = date.toISOString().split('T')[0];
    
    tasks.forEach(task => {
        const taskDate = new Date(task.deadline);
        if (taskDate.toISOString().split('T')[0] === dateStr) {
            events.push({
                title: `üìã ${task.title}`,
                color: task.status === 'done' ? '#28a745' : task.status === 'in progress' ? '#17a2b8' : '#ffc107'
            });
        }
    });
    
    meetings.forEach(meetingData => {
        const meeting = meetingData.meeting;
        const meetingDate = new Date(meeting.start_at);
        if (meetingDate.toISOString().split('T')[0] === dateStr) {
            events.push({
                title: `üë• –í—Å—Ç—Ä–µ—á–∞`,
                color: '#667eea'
            });
        }
    });
    
    return events;
}

function showDayTimeline(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const dayTasks = tasks.filter(task => {
        if (!task.deadline) return false;
        const taskDate = new Date(task.deadline);
        return taskDate.toISOString().split('T')[0] === dateStr;
    });
    
    const dayMeetings = meetings.filter(meetingData => {
        const meeting = meetingData.meeting;
        const meetingDate = new Date(meeting.start_at);
        return meetingDate.toISOString().split('T')[0] === dateStr;
    });
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const events = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å—Ç—Ä–µ—á–∏
    dayMeetings.forEach(meetingData => {
        const meeting = meetingData.meeting;
        const start = new Date(meeting.start_at);
        const end = new Date(meeting.end_at);
        const participants = getMeetingParticipants(meetingData);
        
        events.push({
            type: 'meeting',
            title: '–í—Å—Ç—Ä–µ—á–∞',
            time: start,
            startTime: start.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
            endTime: end.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
            color: '#667eea',
            meeting: meeting,
            participants
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏
    dayTasks.forEach(task => {
        const deadline = new Date(task.deadline);
        
        events.push({
            type: 'task',
            title: task.title,
            time: deadline,
            startTime: deadline.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
            color: task.status === 'done' ? '#28a745' : task.status === 'in progress' ? '#17a2b8' : '#ffc107',
            task: task
        });
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    events.sort((a, b) => a.time - b.time);
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'dayTimelineModal';
    
    const dateFormatted = date.toLocaleDateString('ru-RU', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    let html = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>–°–æ–±—ã—Ç–∏—è –Ω–∞ ${dateFormatted}</h3>
                <button onclick="closeDayTimelineModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
    `;
    
    if (events.length === 0) {
        html += '<div class="empty">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</div>';
    } else {
        html += '<div class="events-list">';
        events.forEach(event => {
            html += `
                <div class="event-item" style="background: ${event.color}; padding: 1rem; margin-bottom: 0.75rem; border-radius: 5px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">
                                ${event.type === 'meeting' ? 'üë• –í—Å—Ç—Ä–µ—á–∞' : 'üìã ' + event.title}
                            </div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">
                                ${event.startTime}${event.endTime ? ' - ' + event.endTime : ''}
                            </div>
                            ${event.type === 'meeting' ? `
                                <div style="margin-top: 0.35rem; font-size: 0.85rem; opacity: 0.95;">
                                    <strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</strong> ${event.participants && event.participants.length ? event.participants.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    html += `
            </div>
        </div>
    `;
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
}

function closeDayTimelineModal() {
    const modal = document.getElementById('dayTimelineModal');
    if (modal) {
        modal.remove();
    }
}

function buildUserDirectory(teamList) {
    const directory = {};
    teamList.forEach(teamEntry => {
        const members = teamEntry?.team?.teamuser || [];
        members.forEach(member => {
            const user = member.user_relation;
            if (user && user.uuid) {
                directory[user.uuid] = {
                    username: user.username,
                    email: user.email
                };
            }
        });
    });
    if (window.currentUserProfile?.uuid) {
        directory[window.currentUserProfile.uuid] = {
            username: window.currentUserProfile.username,
            email: window.currentUserProfile.email
        };
    }
    return directory;
}

function getMeetingParticipants(meetingData) {
    const rawParticipants = extractParticipants(meetingData);
    if (rawParticipants.length === 0) {
        const fallbackUuid = meetingData.user_uuid || window.currentUserProfile?.uuid;
        if (fallbackUuid) {
            return [formatParticipantLabel({ uuid: fallbackUuid })];
        }
        return [];
    }
    return rawParticipants.map(participant => formatParticipantLabel(participant));
}

function extractParticipants(meetingData) {
    if (!meetingData) {
        return [];
    }
    const meetingParticipants = meetingData.meeting?.participants;
    if (Array.isArray(meetingParticipants) && meetingParticipants.length > 0) {
        return meetingParticipants;
    }
    if (Array.isArray(meetingData.participants) && meetingData.participants.length > 0) {
        return meetingData.participants;
    }
    return [];
}

function formatParticipantLabel(participant) {
    if (!participant) {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
    const directUser = participant.user_relation || participant.user;
    if (directUser) {
        return formatUserDisplay(directUser);
    }
    const uuid = participant.user_uuid || participant.uuid || participant;
    if (userDirectory[uuid]) {
        return formatUserDisplay({
            username: userDirectory[uuid].username,
            email: userDirectory[uuid].email,
            uuid
        });
    }
    if (participant.username || participant.email) {
        return formatUserDisplay(participant);
    }
    return shortenUuid(uuid);
}

function formatUserDisplay(user) {
    if (!user) {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
    if (user.username && user.email) {
        return `${user.username} (${user.email})`;
    }
    if (user.username) {
        return user.username;
    }
    if (user.email) {
        return user.email;
    }
    return shortenUuid(user.uuid);
}

function shortenUuid(uuid) {
    if (!uuid) {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
    const value = typeof uuid === 'string' ? uuid : String(uuid);
    return value.length > 8 ? `${value.slice(0, 8)}...` : value;
}
</script>
{% endblock %}

