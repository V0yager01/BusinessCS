<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Система управления бизнесом" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <header>
        <h1>Система управления бизнесом</h1>
        <nav id="navMenu">
            <a href="/">Главная</a>
            <a href="/login" id="loginLink">Вход</a>
            <a href="/register" id="registerLink">Регистрация</a>
            <a href="/teams" id="teamsLink" style="display: none;">Команды</a>
            <a href="/tasks" id="tasksLink" style="display: none;">Задачи</a>
            <a href="/meetings" id="meetingsLink" style="display: none;">Встречи</a>
            <a href="/calendar" id="calendarLink" style="display: none;">Календарь</a>
            <a href="/evaluations" id="evaluationsLink" style="display: none;">Оценки</a>
            <a href="/profile" id="profileLink" style="display: none;">Профиль</a>
            <a href="#" id="logoutLink" style="display: none;">Выход</a>
        </nav>
    </header>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer>
        <p>© 2025 BusinessManager</p>
    </footer>

    <script src="{{ url_for('static', path='/api.js') }}"></script>
    <script>
    const ROLE_PRIORITY = { user: 0, manager: 1, admin: 2 };

    function hasRequiredRole(currentRole, requiredRole) {
        if (!requiredRole) {
            return true;
        }
        const currentPriority = ROLE_PRIORITY[currentRole] ?? -1;
        const requiredPriority = ROLE_PRIORITY[requiredRole] ?? Number.MAX_SAFE_INTEGER;
        return currentPriority >= requiredPriority;
    }

    function toggleAuthLinks({ loginLink, registerLink, profileLink, logoutLink }, isAuthenticated) {
        if (loginLink) loginLink.style.display = isAuthenticated ? 'none' : 'inline';
        if (registerLink) registerLink.style.display = isAuthenticated ? 'none' : 'inline';
        if (profileLink) profileLink.style.display = isAuthenticated ? 'inline' : 'none';
        if (logoutLink) logoutLink.style.display = isAuthenticated ? 'inline' : 'none';
        if (isAuthenticated && profileLink) {
            profileLink.href = '/profile';
        }
    }

    function toggleProtectedLink(linkElement, currentRole) {
        if (!linkElement) {
            return;
        }
        const requiredRole = linkElement.dataset.role;
        linkElement.style.display = hasRequiredRole(currentRole, requiredRole) ? 'inline' : 'none';
    }

    function clearProfileReference() {
        delete window.currentUserProfile;
        delete window.currentUserRole;
    }

    async function resolveCurrentProfile() {
        if (typeof UserAPI === 'undefined') {
            return null;
        }
        try {
            const profile = await UserAPI.getMe();
            window.currentUserProfile = profile;
            window.currentUserRole = profile?.role ?? null;
            return profile;
        } catch (error) {
            console.warn('Не удалось получить профиль пользователя', error);
            return null;
        }
    }

    async function initNavigationMenu() {
        const token = localStorage.getItem('access_token');
        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        const teamsLink = document.getElementById('teamsLink');
        const tasksLink = document.getElementById('tasksLink');
        const meetingsLink = document.getElementById('meetingsLink');
        const calendarLink = document.getElementById('calendarLink');
        const evaluationsLink = document.getElementById('evaluationsLink');
        const profileLink = document.getElementById('profileLink');
        const logoutLink = document.getElementById('logoutLink');

        const dynamicLinks = [teamsLink, tasksLink, meetingsLink, calendarLink, evaluationsLink];

        if (!token) {
            toggleAuthLinks({ loginLink, registerLink, profileLink, logoutLink }, false);
            dynamicLinks.forEach(link => {
                if (link) link.style.display = 'none';
            });
            clearProfileReference();
            return;
        }

        toggleAuthLinks({ loginLink, registerLink, profileLink, logoutLink }, true);

        const profile = await resolveCurrentProfile();
        const currentRole = profile?.role ?? null;

        dynamicLinks.forEach(link => toggleProtectedLink(link, currentRole));

        if (logoutLink && !logoutLink.dataset.bound) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('access_token');
                clearProfileReference();
                window.location.href = '/';
            });
            logoutLink.dataset.bound = 'true';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initNavigationMenu();
    });
    </script>
    {% block scripts %}
    {% endblock %}
</body>
</html>
